https://thayer.github.io/engs50/Notes/debug/extra/
3
17457
<!DOCTYPEhtml><html><head><metacharset="utf-8"><metahttp-equiv="X-UA-Compatible"content="IE=edge"><metaname="viewport"content="width=device-width,initial-scale=1"><title>Extra-Moregdbandprofilingperformancewithgprof</title><metaname="description"content="InEngs50youwilllearnhowtodesign&buildlarge,reliable,maintainable,andunderstandablesoftwaresystems.IntheprocessyouwilllearntoprograminCwithUnixdevelopmenttools."><linkrel="shortcuticon"href="/engs50/50.png"/><linkrel="stylesheet"href="/engs50/css/main.css"><linkrel="canonical"href="/engs50/Notes/debug/extra/"></head><body><headerclass="site-header"><aclass="site-title"href="/engs50/"><imgwidth=48align=centersrc="/engs50/50.png"alt="icon">Engs50(CS50)</a><navclass="site-nav">[<ahref="/engs50/Labs/">Labs</a>][<ahref="/engs50/Notes/">Notes</a>][<ahref="/engs50/Reading/">Reading</a>][<ahref="/engs50/Resources/">Resources</a>][<ahref="/engs50/Examples/">Examples</a>]</nav></header><divclass="page-content"><divclass="wrapper"><articleclass="post"><headerclass="post-header"><h1class="post-title">Extra-Moregdbandprofilingperformancewithgprof</h1></header><divclass="post-content"><h3id="using-gdb-to-debug-core-files">Usinggdbtodebug“core”files</h3><p>Somethingyouwilllikelyencounterinyourprogrammingendevorsisthenotorious“coredump.”Acoredumpisreallynothingmorethanarecordoftheworkingmemoryofaprogramataspecificpointintime;usuallythispointintimeiswhenaprogramdoessomethingbadandthecomputerdoesn’tknowhowtohandletheissue.Thecomputersimplyraisesitshandsandsays“I’mdone.Ikilledtheprogramanddumpedabunchofinformationinafileforyoutoreviewifyouwant.”Incs50acommonnoticeisthe“segfault”or“segmentationfault”whichreferstoaccessinginvalidmemory.</p><p>Itjustsohappensthatgdbcantakecoredumpfilesasinput.Generallyspeaking,youcanstartgdbwithnoarguments,orwiththenameofanexectuableasanargument.Youcanalsostartgdbwithbothanexecutableprogram<em>and</em>acorefilespecified:</p><divclass="language-bashhighlighter-rouge"><divclass="highlight"><preclass="highlight"><code><spanclass="nv">$</span>gdbprogramcore</code></pre></div></div><p><strong>Important:</strong>Linuxhasrecentlychangedthewaycoredumpsareproduced.Traditionally,whenyourprogramcrashedwitha‘segmentationfault’orcertainothererrors,Unixwould“dumpcore”.Thatis,itwroteasnapshotcopyoftheprocess’smemoryintoafilecalled<codeclass="language-plaintexthighlighter-rouge">core</code>inthecurrentworkingdirectory.Thesefilesare<em>huge</em>.Programmers(orusers)oftendon’tnoticethem,andthefilesystembecomeslitteredwithdroppings.<em>Huge</em>droppings.SoLinuxnowdumpscorefilesinacentrallocation,wheretheycanbemanaged,andcleanedup.Tofindyourcorefiles,type</p><divclass="language-bashhighlighter-rouge"><divclass="highlight"><preclass="highlight"><code><spanclass="nv">$</span>coredumpctllist</code></pre></div></div><p>Andtouseoneofthosecorefileswithgdb,say,theoneassociatedwithdeadprocess20421,</p><divclass="language-bashhighlighter-rouge"><divclass="highlight"><preclass="highlight"><code><spanclass="nv">$</span>coredumpctlgdb 20421</code></pre></div></div><p>Formoreinformation,readthedepartment’swiki<ahref="https://wiki.cs.dartmouth.edu/faq/doku.php/users_faq:coredump">pageaboutcoredumps</a>.</p><p>Inthisclassitisusuallysufficienttodebugtheprogramdirectlyandyoureallyshouldn’tneedtoconcernyourselfwithdebugging<codeclass="language-plaintexthighlighter-rouge">core</code>filesdirectly.Thereareadvantagestodebugginga<codeclass="language-plaintexthighlighter-rouge">core</code>file,however,sinceitgenerallycapturesstatesuchasthevaluesoftheprocessorregistersatthetimeofthecoredump,informationabouttheprocessor,flagsthataresetinyourOS(i.e.,OSconfigurations),andsoforth.</p><h3id="the-gprof-tool">The<codeclass="language-plaintexthighlighter-rouge">gprof</code>Tool</h3><p><strong><em>NOTE:Inthesenotestherearemanyreferencestothe“crawler.”Thisprogramwillbecodedbyyouinafutureassignment.</em></strong></p><p>The<codeclass="language-plaintexthighlighter-rouge">gprof</code>toolisusedtoprofiletheruntimeperformanceofcode.Manytimesyoumightbeconfidentthatthecodeisbugfreebecausethereareno<em>functional</em>problems.However,thecodecouldbeworthlessifitdoesnotmeetitsperformancerequirements.The<codeclass="language-plaintexthighlighter-rouge">gprof</code>toolisanexecutionprofilingtoolthatisusefulwhentrackingdownperformanceproblems.</p><p><strong>Warning.</strong><codeclass="language-plaintexthighlighter-rouge">gprof</code>doesn’talwaysworkwellonMacOS.Logontoamachineinthelabtotryitout.</p><p>Anecdotalevidence.Manytimeprogrammersfocusongettingthecodetoworkfunctionallyandthenthinkaboutspeedup.Thisisnotalwaysthemostproductiveapproachtodesignorsystemsdevelopment.Besttodesignforspeedifneeded(e.g.,useahashtableinsteadofsearchingalongdoublelinkedlist).</p><blockquote><p><strong>AnAnecdotefromAndrewCampbell:</strong>Irecallonceworkingasaconsultantonimprovingtheperformanceofaradiorouter.TheperformanceofthesystemcodedinAdawasappallingandsomeone`sheadwasabouttoroll.Ispendprobablytwoweeksjuststudyingthecodeofaverylargesystem-difficulttokeepthatallinyourhead.Profilingthecodehighlightedthecostofasystemthathadbeendesigedandcodedwithanexcessivenumberoftasksandrendezvous.Thecostofinterprocesscommunicationswashigh.WhatdidIdo?Itwasnotnice.Turnedthesystemintoonelargetaskandreplacedallinterprocesscommunications(IPC)(whichrepresentedsystemcalls)withmylibrarythatimplementedtheIPCAPI.Ichangedacouple100linesofcodeinasystemof20,000linesofcode.Theimprovementwasmassive.Packetscouldbeforwardedfromoneradioinputtotheoutputradioinunder100msecwhichwasdownfrom1second!Iwaskingfortheday,orweek.Imademychanges,testedthemlocally,deskcheckedthecodeclosely-and,itranfirsttime!Theguywhodesignedthesystemwantedmetofail-Icouldfeelit.Butwhenthatrouterranfirsttime,well,thatisamomentIwillalwaysremember.Myreward?Igottodesignthenextsystem.Theproblemwasessentiallyaperformancebug.Thechangesweresimpleoncetheproblemwasidentified.ItookaveryradicalapproachthatranagainstOOdesign.Butthatiswhatwasneeded.Arouterthatforwardedpacketsat1secondintervalswasnotgoingtoflywiththecustomer.</p></blockquote><p>Torunthe<codeclass="language-plaintexthighlighter-rouge">gprof</code>tool,firstusethe<codeclass="language-plaintexthighlighter-rouge">-pg</code>switchinthecompilerflags:</p><divclass="language-makefilehighlighter-rouge"><divclass="highlight"><preclass="highlight"><code><spanclass="c">#Filename:Makefile#Description:Themakefileistobuildupthecrawler.</span><spanclass="nv">CC</span><spanclass="o">=</span>gcc<spanclass="nv">CFLAGS</span><spanclass="o">=</span><spanclass="nt">-Wall</span><spanclass="nt">-pg</span><spanclass="nt">-pedantic</span><spanclass="nt">-std</span><spanclass="o">=</span>c11<spanclass="nv">SOURCES</span><spanclass="o">=</span>./list.h./list.c./crawler.c../util/hash.c../util/html.c</code></pre></div></div><p>Onceyouhavedoneabuildwith<codeclass="language-plaintexthighlighter-rouge">-pg</code>thenruntheapplication.</p><divclass="language-bashhighlighter-rouge"><divclass="highlight"><preclass="highlight"><code><spanclass="nv">$</span><spanclass="nb">pwd</span>/net/nusers/campbell/cs50/l16/lab4/src/crawler<spanclass="nv">$</span>./crawlerwww.cs.dartmouth.edu../../data/2</code></pre></div></div><p>Nowyouarereadytorunthe<codeclass="language-plaintexthighlighter-rouge">gprof</code>tool:</p><divclass="language-bashhighlighter-rouge"><divclass="highlight"><preclass="highlight"><code><spanclass="nv">$</span>gprofcrawlergmon.out<spanclass="o">&gt;</span>profile</code></pre></div></div><p>Anexcerptfromtheoutputoftheprofileisbelow.Youcanlearnalotaboutwhereyourprogramisspendingtimebystudyingthisoutput.Thereisareasonableamountofdocumentationincludedinthereportwhichwillhelptheinterestedpersonnavigatethereport’soutput,andthere’salsolotsmoreinthe<codeclass="language-plaintexthighlighter-rouge">man</code>pages.</p><divclass="language-bashhighlighter-rouge"><divclass="highlight"><preclass="highlight"><code>Flatprofile:Eachsamplecountsas0.01seconds.%cumulativeselfselftotal<spanclass="nb">time</span>secondssecondscallsus/callus/callname35.750.050.05203246.54246.54removeWhiteSpace14.300.070.02437140.460.46hash114.300.090.02221860.903.16GetNextURL7.150.100.01215330.460.46NormalizeURL7.150.110.0113517.417.94DAdd7.150.120.0113517.417.41getAddressFromTheLinksToBeVisited7.150.130.0120349.31394.47extractURLs7.150.140.0120349.31237.36updateListLinkToBeVisited0.000.140.00437140.000.46make_hash0.000.140.00211470.000.91GetDataWithKey0.000.140.00197950.001.45addElement0.000.140.0013510.001.38setURLasVisited0.000.140.002080.000.00getPage0.000.140.002030.000.00ReadFileToMemoryOrDie0.000.140.002030.000.00file_length0.000.140.0010.000.00CleanDictionary0.000.140.0010.000.00InitDictionary0.000.140.0010.000.00IsDirectory0.000.140.0010.000.00cleanup0.000.140.0010.000.00initList%thepercentageofthetotalrunning<spanclass="nb">time</span>ofthe<spanclass="nb">time</span>programusedbythis<spanclass="k">function</span><spanclass="nb">.</span>cumulativearunning<spanclass="nb">sum</span>ofthenumberofsecondsaccountedseconds<spanclass="k">for</span>bythis<spanclass="k">function</span>andthoselistedaboveit.selfthenumberofsecondsaccounted<spanclass="k">for</span>bythisseconds<spanclass="k">function</span>alone.Thisisthemajor<spanclass="nb">sort</span><spanclass="k">for</span>thislisting.callsthenumberof<spanclass="nb">times</span>this<spanclass="k">function</span>wasinvoked,<spanclass="k">if</span>this<spanclass="k">function</span>isprofiled,<spanclass="k">else</span>blank.selftheaveragenumberofmillisecondsspent<spanclass="k">in</span>thisms/call<spanclass="k">function</span>percall,<spanclass="k">if</span>this<spanclass="k">function</span>isprofiled,<spanclass="k">else</span>blank.totaltheaveragenumberofmillisecondsspent<spanclass="k">in</span>thisms/call<spanclass="k">function</span>anditsdescendentspercall,<spanclass="k">if</span>this<spanclass="k">function</span>isprofiled,<spanclass="k">else</span>blank.namethenameofthe<spanclass="k">function</span><spanclass="nb">.</span>Thisistheminor<spanclass="nb">sort</span><spanclass="k">for</span>thislisting.Theindexshowsthelocationofthe<spanclass="k">functionin</span>thegproflisting.Iftheindexis<spanclass="k">in</span>parenthesisitshowswhereitwouldappear<spanclass="k">in</span>thegproflisting<spanclass="k">if</span>itweretobeprinted.^LCallgraph<spanclass="o">(</span>explanationfollows<spanclass="o">)</span>granularity:eachsamplehitcovers2byte<spanclass="o">(</span>s<spanclass="o">)</span><spanclass="k">for</span>7.14%of0.14secondsindex%<spanclass="nb">time</span>selfchildrencalledname<spanclass="o">[</span>1]100.00.000.14main<spanclass="o">[</span>1]0.010.07203/203extractURLs<spanclass="o">[</span>2]0.010.04203/203updateListLinkToBeVisited<spanclass="o">[</span>5]0.010.001351/1351getAddressFromTheLinksToBeVisited<spanclass="o">[</span>12]0.000.001351/1351setURLasVisited<spanclass="o">[</span>13]0.000.00208/208getPage<spanclass="o">[</span>14]0.000.001/1IsDirectory<spanclass="o">[</span>19]0.000.001/1initList<spanclass="o">[</span>21]0.000.001/1cleanup<spanclass="o">[</span>20]<spanclass="nt">-----------------------------------------------</span>0.010.07203/203main<spanclass="o">[</span>1]<spanclass="o">[</span>2]57.10.010.07203extractURLs<spanclass="o">[</span>2]0.020.0522186/22186GetNextURL<spanclass="o">[</span>3]<spanclass="nt">-----------------------------------------------</span><spanclass="nt">-----------------------------------------------</span>1676GetNextURL<spanclass="o">[</span>3]0.020.0522186/22186extractURLs<spanclass="o">[</span>2]<spanclass="o">[</span>3]50.00.020.0522186+1676GetNextURL<spanclass="o">[</span>3]0.050.00203/203removeWhiteSpace<spanclass="o">[</span>4]1676GetNextURL<spanclass="o">[</span>3]<spanclass="nt">-----------------------------------------------</span>0.050.00203/203GetNextURL<spanclass="o">[</span>3]<spanclass="o">[</span>4]35.70.050.00203removeWhiteSpace<spanclass="o">[</span>4]<spanclass="nt">-----------------------------------------------</span>0.010.04203/203main<spanclass="o">[</span>1]<spanclass="o">[</span>5]34.40.010.04203updateListLinkToBeVisited<spanclass="o">[</span>5]0.000.0319794/19795addElement<spanclass="o">[</span>6]0.010.0020182/21533NormalizeURL<spanclass="o">[</span>11]<spanclass="nt">-----------------------------------------------</span>0.000.001/19795setURLasVisited<spanclass="o">[</span>13]0.000.0319794/19795updateListLinkToBeVisited<spanclass="o">[</span>5]<spanclass="o">[</span>6]20.50.000.0319795addElement<spanclass="o">[</span>6]0.000.0219795/21147GetDataWithKey<spanclass="o">[</span>9]0.010.001351/1351DAdd<spanclass="o">[</span>10]<spanclass="nt">-----------------------------------------------</span>0.020.0043714/43714make_hash<spanclass="o">[</span>8]<spanclass="o">[</span>7]14.30.020.0043714hash1<spanclass="o">[</span>7]<spanclass="nt">-----------------------------------------------</span>...152linesomitted</code></pre></div></div></div></article></div></div><footerclass="site-footer"><divclass="wrapper"><h2class="footer-heading">Engs50(CS50)--DartmouthCollege</h2><p><fontsize=-1>ThisversionofthecourseisbaseduponthosedesignedbyProfessorsPalmer,Kotz,Zhou,Campbell,andBalkcom.Iamdeeplyindebtedtotheseoutstandingeducators.--<ahref="https://engineering.dartmouth.edu/people/faculty/stephen-taylor/">StephenTaylor</a></font></p><p><small>Thispagewaslastupdatedon<strong>2023-01-05</strong>at<strong>11:31</strong>.</small></p></div></footer></body></html>
