https://thayer.github.io/engs50/Notes/design/makefiles.html
3
17751
<!DOCTYPEhtml><html><head><metacharset="utf-8"><metahttp-equiv="X-UA-Compatible"content="IE=edge"><metaname="viewport"content="width=device-width,initial-scale=1"><title>MoreaboutMakefiles</title><metaname="description"content="InEngs50youwilllearnhowtodesign&buildlarge,reliable,maintainable,andunderstandablesoftwaresystems.IntheprocessyouwilllearntoprograminCwithUnixdevelopmenttools."><linkrel="shortcuticon"href="/engs50/50.png"/><linkrel="stylesheet"href="/engs50/css/main.css"><linkrel="canonical"href="/engs50/Notes/design/makefiles.html"></head><body><headerclass="site-header"><aclass="site-title"href="/engs50/"><imgwidth=48align=centersrc="/engs50/50.png"alt="icon">Engs50(CS50)</a><navclass="site-nav">[<ahref="/engs50/Labs/">Labs</a>][<ahref="/engs50/Notes/">Notes</a>][<ahref="/engs50/Reading/">Reading</a>][<ahref="/engs50/Resources/">Resources</a>][<ahref="/engs50/Examples/">Examples</a>]</nav></header><divclass="page-content"><divclass="wrapper"><articleclass="post"><headerclass="post-header"><h1class="post-title">MoreaboutMakefiles</h1></header><divclass="post-content"><h3id="goals">Goals</h3><ul><li>AnotherlookatMakefiles</li><li>Producingandusinglibraryarchives</li></ul><p>Foradeeperdiveinto<codeclass="language-plaintexthighlighter-rouge">make</code>,recallthe<ahref="/makefiles/extra/">lectureextra</a>.</p><!--Seetoday'sterminal[script](/engs50/Notes/design/script.txt).--><h2id="makefiles">Makefiles</h2><p>RecalltheMakefilewewrotein<ahref="/makefiles/">Lecture</a>–availableas<ahref="/engs50/Examples/names-Makefile">names-Makefile</a>inourexamplesdirectory.</p><divclass="language-plaintexthighlighter-rouge"><divclass="highlight"><preclass="highlight"><code>#Makefileforthe"names"programthatusesthe"bag"module.##DavidKotz-April2017CC=gccCFLAGS=-Wall-pedantic-std=c11-ggdbPROG=namesOBJS=names.obag.oreadlinep.oLIBS=-lm.PHONY:allcleanall:names#executabledependsonobjectfiles$(PROG):$(OBJS)$(CC)$(CFLAGS)$(OBJS)$(LIBS)-o$(PROG)#objectfilesdependonincludefilesnames.o:bag.hreadlinep.hbag.o:bag.hreadlinep.o:readlinep.hclean:rm-f$(PROG)rm-f*~*.orm-rf*.dSYM</code></pre></div></div><p>Let’smodifytheMakefiletoleverageournew<codeclass="language-plaintexthighlighter-rouge">libcs50</code>libraryfromthe<ahref="https://gitlab.cs.dartmouth.edu/CS50/tse">Lab4starterkit</a>.</p><p>Iadaptedthe<codeclass="language-plaintexthighlighter-rouge">names9.c</code>forusewithalibrary-provided<em>bag</em>,resultinginfile<codeclass="language-plaintexthighlighter-rouge">names.c</code>onedirectory,anddroppedinthe<codeclass="language-plaintexthighlighter-rouge">libcs50</code>directoryasapeer.(Thisprogramisnowavailableas<ahref="/engs50/Examples/namesB.c">namesB.c</a>.</p><divclass="language-plaintexthighlighter-rouge"><divclass="highlight"><preclass="highlight"><code>[cs50@flume~/demo]$treelecturelibcs50/lecture├──Makefile└──names.clibcs50/├──bag.c├──bag.h├──counters.c├──counters.h├──file.c├──file.h├──file.md├──hashtable.c├──hashtable.h├──jhash.c├──jhash.h├──Makefile├──memory.c├──memory.h├──memory.md├──README.md├──set.c├──set.h├──webpage.c├──webpage_fetch.c├──webpage.h├──webpage_internal.h└──webpage.md</code></pre></div></div><p>ThenewMakefilefor<em>names</em>follows.Noticeseveralimportantfeatures:</p><ul><li><p>definitionofmacro<codeclass="language-plaintexthighlighter-rouge">L</code>asashorthandforthedirectoryname(notthelibraryname)wherethelibrarylives.Makeallowsustosubstitutethevalueofsingle-lettermacronameswithoutusingparens;thus,Icanuse<codeclass="language-plaintexthighlighter-rouge">$L</code>tosubstitutethisdirectoryname.</p></li><li><p>additionof<codeclass="language-plaintexthighlighter-rouge">-I$L</code>tothe<codeclass="language-plaintexthighlighter-rouge">CFLAGS</code>,whichtellsthecompilertolookfor<codeclass="language-plaintexthighlighter-rouge">include</code>filesinthedirectory<codeclass="language-plaintexthighlighter-rouge">$L</code></p></li><li><p>theexisting<codeclass="language-plaintexthighlighter-rouge">LIBS</code>macro,meaning“libraries”,usedtotellthelinkertolinkwiththe<em>mathlibrary</em>;<codeclass="language-plaintexthighlighter-rouge">-lm</code></p></li><li><p>thenew<codeclass="language-plaintexthighlighter-rouge">LLIBS</code>macro,bywhichImean“locallibraries”,usedtotellthelinkertolinkwiththelibcs50library;Ikeepthisseparatefrom<codeclass="language-plaintexthighlighter-rouge">LIBS</code>becauseIwanttoinformMakethattheprogramdependsonthislibraryin<em>my</em>directories.</p></li><li><p>thedefault<codeclass="language-plaintexthighlighter-rouge">all</code>rule,justtobeclear</p></li><li><p>theupdated<codeclass="language-plaintexthighlighter-rouge">$(PROG)</code>generalrule,whichindicatesdependenceon<codeclass="language-plaintexthighlighter-rouge">$(LLIBS)</code>andalsoprovidesthemtothelinkercommand(thenextline).</p></li><li><p>the<codeclass="language-plaintexthighlighter-rouge">names.o</code>rule,whichuses<codeclass="language-plaintexthighlighter-rouge">$L</code>torefertotheincludefilesneededbythisprogram.</p></li><li><p>thelackofanyruletobuildthelibrary<codeclass="language-plaintexthighlighter-rouge">libcs50.a</code>;itisnotthejobofthisMakefiletobuildthatlibrary.</p></li></ul><divclass="language-makehighlighter-rouge"><divclass="highlight"><preclass="highlight"><code><spanclass="c">#Makefileforthe"names"programthatusesthe"bag"module.##DavidKotz-April2017</span><spanclass="nv">L</span><spanclass="o">=</span>../libcs50<spanclass="nv">CC</span><spanclass="o">=</span>gcc<spanclass="nv">CFLAGS</span><spanclass="o">=</span><spanclass="nt">-Wall</span><spanclass="nt">-pedantic</span><spanclass="nt">-std</span><spanclass="o">=</span>c11<spanclass="nt">-ggdb</span><spanclass="nt">-I</span><spanclass="nv">$L</span><spanclass="nv">PROG</span><spanclass="o">=</span>names<spanclass="nv">OBJS</span><spanclass="o">=</span>names.o<spanclass="nv">LIBS</span><spanclass="o">=</span><spanclass="nt">-lm</span><spanclass="nv">LLIBS</span><spanclass="o">=</span><spanclass="nv">$L</span>/libcs50.a<spanclass="nl">.PHONY</span><spanclass="o">:</span><spanclass="nf">allclean</span><spanclass="nl">all</span><spanclass="o">:</span><spanclass="nf">$(PROG)</span><spanclass="c">#executabledependsonobjectfiles</span><spanclass="nl">$(PROG)</span><spanclass="o">:</span><spanclass="nf">$(OBJS)$(LLIBS)</span><spanclass="nv">$(CC)</span><spanclass="nv">$(CFLAGS)</span><spanclass="nv">$(OBJS)</span><spanclass="nv">$(LLIBS)</span><spanclass="nv">$(LIBS)</span><spanclass="nt">-o</span><spanclass="nv">$(PROG)</span><spanclass="c">#objectfilesdependonincludefiles</span><spanclass="nl">names.o</span><spanclass="o">:</span><spanclass="nf">$L/bag.h$L/file.h</span><spanclass="nl">clean</span><spanclass="o">:</span><spanclass="nb">rm</span><spanclass="nt">-f</span><spanclass="nv">$(PROG)</span><spanclass="nb">rm</span><spanclass="nt">-f</span><spanclass="k">*</span>~<spanclass="k">*</span>.o<spanclass="nb">rm</span><spanclass="nt">-rf</span><spanclass="k">*</span>.dSYM</code></pre></div></div><h2id="producing-library-archives">Producinglibraryarchives</h2><p>Whatisa“library”fileandhowdoyoumakeone?</p><p>A<em>libraryfile</em>issimplyan<em>archiveofobjectfiles.</em>An<em>archive</em>isasinglefilethatcontainsacollectionofotherfiles;you’veprobablydownloaded<codeclass="language-plaintexthighlighter-rouge">.zip</code>,<codeclass="language-plaintexthighlighter-rouge">.tgz</code>,or<codeclass="language-plaintexthighlighter-rouge">.dmg</code>filesbefore;thosearevariousformsofarchive.Insidethosefilesissomemetadatadescribingtheenclosedfiles,aswellasthe(oftencompressed)dataoftheoriginalfiles.</p><p>InUnix,thereisaspecifictypeofarchiveusedforcoalescingobject<codeclass="language-plaintexthighlighter-rouge">.o</code>filesintoasingle<codeclass="language-plaintexthighlighter-rouge">.a</code>file,forconvenience.Thelinker<codeclass="language-plaintexthighlighter-rouge">ld</code>knowshowtoread<codeclass="language-plaintexthighlighter-rouge">.a</code>files.Itlinksinany<codeclass="language-plaintexthighlighter-rouge">.o</code>filesthatcontainsymbolsthatareas-yetunresolvedwhenitreachesthatpointinitsargumentlistoffiles;whenitpullsina<codeclass="language-plaintexthighlighter-rouge">.o</code>fileitpullsinthatwhole<codeclass="language-plaintexthighlighter-rouge">.o</code>file.Thatfilemay,inturn,referenceothersymbols-ifthoseareinanother<codeclass="language-plaintexthighlighter-rouge">.o</code>fileinthesamearchive,thelinkerloadsthemtoo.Anysymbolsstillunresolvedafterthecurrent<codeclass="language-plaintexthighlighter-rouge">.a</code>fileisexhaustedbetterbeinanother<codeclass="language-plaintexthighlighter-rouge">.o</code>or<codeclass="language-plaintexthighlighter-rouge">.a</code>filelaterintheargumentlist.<em>Thus,theorderofargumentstothelinkerisimportant.</em></p><p>Anyway,apeekinside<codeclass="language-plaintexthighlighter-rouge">libcs50/Makefile</code>showshowtobuildanarchive:</p><divclass="language-makehighlighter-rouge"><divclass="highlight"><preclass="highlight"><code><spanclass="c">#objectfiles,andthetargetlibrary</span><spanclass="nv">OBJS</span><spanclass="o">=</span>bag.ocounters.ofile.ohashtable.ojhash.omemory.o<spanclass="se">\</span>set.owebpage.owebpage_fetch.o<spanclass="nv">LIB</span><spanclass="o">=</span>libcs50.a<spanclass="err">...</span><spanclass="c">#Buildthelibrarybyarchivingobjectfiles</span><spanclass="nl">$(LIB)</span><spanclass="o">:</span><spanclass="nf">$(OBJS)</span><spanclass="err">ar</span><spanclass="err">cr</span><spanclass="err">$(LIB)</span><spanclass="err">$(OBJS)</span></code></pre></div></div><p>The<codeclass="language-plaintexthighlighter-rouge">ar</code>commandmanipulatesanarchive<codeclass="language-plaintexthighlighter-rouge">.a</code>file;specifically,<codeclass="language-plaintexthighlighter-rouge">arcr</code>createsthe<codeclass="language-plaintexthighlighter-rouge">.a</code>file(ifneeded)andreplacestheenclosed<codeclass="language-plaintexthighlighter-rouge">.o</code>fileswiththoseonitscommandline.Thus,<codeclass="language-plaintexthighlighter-rouge">libcs50.a</code>holdsallthose<codeclass="language-plaintexthighlighter-rouge">.o</code>files,whichwecanshowwith<codeclass="language-plaintexthighlighter-rouge">art</code>:</p><divclass="language-plaintexthighlighter-rouge"><divclass="highlight"><preclass="highlight"><code>[cs50@flume~/demo/libcs50]$artlibcs50.abag.ocounters.ofile.ohashtable.ojhash.omemory.oset.owebpage.owebpage_fetch.o[cs50@flume~/demo/libcs50]$</code></pre></div></div><h2id="building-it-all">Buildingitall</h2><p>Tobuildthewholeprogram,weneedtobuildthelibraryandthentheprogram.Wecoulddoso,fromthedirectoryabove,withtwocallstoMake:</p><divclass="language-bashhighlighter-rouge"><divclass="highlight"><preclass="highlight"><code><spanclass="o">[</span>cs50@flume~/demo]<spanclass="nv">$</span>make<spanclass="nt">-C</span>libcs50make:Enteringdirectory<spanclass="s1">'/net/class/cs50/demo/libcs50'</span>gcc<spanclass="nt">-Wall</span><spanclass="nt">-pedantic</span><spanclass="nt">-std</span><spanclass="o">=</span>c11<spanclass="nt">-ggdb</span><spanclass="nt">-c</span><spanclass="nt">-o</span>bag.obag.cgcc<spanclass="nt">-Wall</span><spanclass="nt">-pedantic</span><spanclass="nt">-std</span><spanclass="o">=</span>c11<spanclass="nt">-ggdb</span><spanclass="nt">-c</span><spanclass="nt">-o</span>counters.ocounters.cgcc<spanclass="nt">-Wall</span><spanclass="nt">-pedantic</span><spanclass="nt">-std</span><spanclass="o">=</span>c11<spanclass="nt">-ggdb</span><spanclass="nt">-c</span><spanclass="nt">-o</span>file.ofile.cgcc<spanclass="nt">-Wall</span><spanclass="nt">-pedantic</span><spanclass="nt">-std</span><spanclass="o">=</span>c11<spanclass="nt">-ggdb</span><spanclass="nt">-c</span><spanclass="nt">-o</span>hashtable.ohashtable.cgcc<spanclass="nt">-Wall</span><spanclass="nt">-pedantic</span><spanclass="nt">-std</span><spanclass="o">=</span>c11<spanclass="nt">-ggdb</span><spanclass="nt">-c</span><spanclass="nt">-o</span>jhash.ojhash.cgcc<spanclass="nt">-Wall</span><spanclass="nt">-pedantic</span><spanclass="nt">-std</span><spanclass="o">=</span>c11<spanclass="nt">-ggdb</span><spanclass="nt">-c</span><spanclass="nt">-o</span>memory.omemory.cgcc<spanclass="nt">-Wall</span><spanclass="nt">-pedantic</span><spanclass="nt">-std</span><spanclass="o">=</span>c11<spanclass="nt">-ggdb</span><spanclass="nt">-c</span><spanclass="nt">-o</span>set.oset.cgcc<spanclass="nt">-Wall</span><spanclass="nt">-pedantic</span><spanclass="nt">-std</span><spanclass="o">=</span>c11<spanclass="nt">-ggdb</span><spanclass="nt">-c</span><spanclass="nt">-o</span>webpage.owebpage.cgcc<spanclass="nt">-Wall</span><spanclass="nt">-pedantic</span><spanclass="nt">-std</span><spanclass="o">=</span>c11<spanclass="nt">-ggdb</span><spanclass="nt">-c</span><spanclass="nt">-o</span>webpage_fetch.owebpage_fetch.carcrlibcs50.abag.ocounters.ofile.ohashtable.ojhash.omemory.oset.owebpage.owebpage_fetch.omake:Leavingdirectory<spanclass="s1">'/net/class/cs50/demo/libcs50'</span><spanclass="o">[</span>cs50@flume~/demo]<spanclass="nv">$</span>make<spanclass="nt">-C</span>lecturemake:Enteringdirectory<spanclass="s1">'/net/class/cs50/demo/lecture'</span>gcc<spanclass="nt">-Wall</span><spanclass="nt">-pedantic</span><spanclass="nt">-std</span><spanclass="o">=</span>c11<spanclass="nt">-ggdb</span><spanclass="nt">-I</span>../libcs50<spanclass="nt">-c</span><spanclass="nt">-o</span>names.onames.cgcc<spanclass="nt">-Wall</span><spanclass="nt">-pedantic</span><spanclass="nt">-std</span><spanclass="o">=</span>c11<spanclass="nt">-ggdb</span><spanclass="nt">-I</span>../libcs50names.o../libcs50/libcs50.a<spanclass="nt">-lm</span><spanclass="nt">-o</span>namesmake:Leavingdirectory<spanclass="s1">'/net/class/cs50/demo/lecture'</span><spanclass="o">[</span>cs50@flume~/demo]<spanclass="nv">$</span></code></pre></div></div><p>Noticethat<em>allbutone</em>ofthe<codeclass="language-plaintexthighlighter-rouge">gcc</code>commandsareexecutedbyMake’simplicitruleforproducinga<codeclass="language-plaintexthighlighter-rouge">.o</code>filefroma<codeclass="language-plaintexthighlighter-rouge">.c</code>file;thefinal<codeclass="language-plaintexthighlighter-rouge">gcc</code>commandisactuallyrunningthelinkerandnottheCcompiler;itsargumentsinclude<codeclass="language-plaintexthighlighter-rouge">names.o</code>,<codeclass="language-plaintexthighlighter-rouge">libcs50.a</code>andthemathlibrary<codeclass="language-plaintexthighlighter-rouge">-lm</code>.(InthisfinalcommandmostoftheCFLAGSareirrelevant,includingthe<codeclass="language-plaintexthighlighter-rouge">-I</code>directive-that’sonlyforincludefiles-butweinclude$(CFLAGS)onthecommandlinejustforcompleteness.)</p><p>Indeed,wecouldwriteatop-levelMakefilethatmakesthosecallstoMake,asshowninthethe<ahref="https://gitlab.cs.dartmouth.edu/CS50/tse">Lab4starterkit</a>.</p><p>Youmaywanttousesimilartechniquesinbuilding<codeclass="language-plaintexthighlighter-rouge">common.a</code>inLab4;justarrangeyourfilesinanappropriatedirectorystructureandthinkcarefullyabouttheincludepath(specifiedwith<codeclass="language-plaintexthighlighter-rouge">-I</code>)andthewayyoulistdependencies.</p></div></article></div></div><footerclass="site-footer"><divclass="wrapper"><h2class="footer-heading">Engs50(CS50)--DartmouthCollege</h2><p><fontsize=-1>ThisversionofthecourseisbaseduponthosedesignedbyProfessorsPalmer,Kotz,Zhou,Campbell,andBalkcom.Iamdeeplyindebtedtotheseoutstandingeducators.--<ahref="https://engineering.dartmouth.edu/people/faculty/stephen-taylor/">StephenTaylor</a></font></p><p><small>Thispagewaslastupdatedon<strong>2023-01-05</strong>at<strong>11:31</strong>.</small></p></div></footer></body></html>
